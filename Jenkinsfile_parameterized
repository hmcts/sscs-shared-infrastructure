#!groovy
import groovy.json.JsonSlurper

@Library('Infrastructure') _

properties([
    parameters([
        string(name: 'PRODUCT_NAME', defaultValue: 'sscs', description: ''),
        string(name: 'ENVIRONMENT', defaultValue: 'sandbox', description: 'Suffix for resources created'),
        choice(name: 'SUBSCRIPTION', choices: 'sandbox\nnonprod\nprod', description: 'Azure subscriptions available to build in'),
        booleanParam(name: 'PLAN_ONLY', defaultValue: true, description: 'set to true for skipping terraform apply')
    ]),
   [$class: 'BuildDiscarderProperty', strategy: [$class: 'LogRotator', artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '7', numToKeepStr: '10']]
])


productName = params.PRODUCT_NAME
subscription = params.SUBSCRIPTION
environment = params.ENVIRONMENT
planOnly = params.PLAN_ONLY


echo "Building '${productName}' in '${environment}'"

node {
  env.PATH = "$env.PATH:/usr/local/bin"

  stage('Checkout') {
    deleteDir()
    checkout scm
  }

  stage('Validate presence of essential tools') {
    sh '''
     #!/bin/bash
     jq --version
     az --version | head -1
    '''
  }

  stage('Derive config variables') {
    // Use the parameters provided to the jenkins job to derive the range of
    // settings we need like vault secrets, azure infrastructure object names
    // etc.
    sh '''
      #!/bin/bash
      chmod +x ./derive-infra-config.sh
      ./derive-infra-config.sh > derived-config.txt
    '''

  stage('Create shared infrastructure') {
    withEnv( readFile('derived-config.txt').split("\r?\n")) {
      // Verify env vars from script are persistent.
      sh '''
        env | grep TF_var
      '''
      sharedInfrastructurePipeline('sscs', params.ENVIRONMENT, 'sandbox')
    }
  }
}
